---
title: "Clustering"
author: "Claus O. Wilke"
date: "last updated: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: [default, "Wilke-slides-theme.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      slideNumberFormat: ''
      titleSlideClass: [center, middle]
params:
  cache: TRUE
---

```{r setup, include=FALSE, echo=FALSE, message = FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(comment = "")

library(tidyverse)
library(broom)
library(cowplot)
library(ggforce)
library(here)

# ggplot2 settings so plots scale well for slide size 
theme_set(theme_gray(16)) # 16 for full width, 18 for half width 
update_geom_defaults("point", list(size = 2.0)) # 2 for full width, 2.5 for half width

# spirals
spirals <- read_csv(here("datasets", "spirals.csv"))
```

```{r kmeans-setup, echo = FALSE}
update_clusters <- function(coords, centroids) {
  dmin <- sqrt((centroids$x[1]-coords$x)^2 + (centroids$y[1]-coords$y)^2)
  cluster <- rep(1, nrow(coords))
  
  for (i in 2:nrow(centroids)) {
    d <- sqrt((centroids$x[i]-coords$x)^2 + (centroids$y[i]-coords$y)^2)
    idx <- d < dmin
    dmin[idx] <- d[idx]
    cluster[idx] <- i
  }
  
  coords$cluster <- factor(cluster)
  coords
}

update_centroids <- function(coords) {
  coords %>%
    group_by(cluster) %>%
    summarize(x = mean(x), y = mean(y)) %>%
    arrange(cluster)
}

random_centroids <- function(coords, n) {
  x <- runif(n, min(coords$x), max(coords$x))
  y <- runif(n, min(coords$y), max(coords$y))
  tibble(x, y, cluster = factor(1:n))
}

make_kmeans_plot <- function(coords, centroids, voronoi_centr, color_points = TRUE, plot_voronoi = TRUE, plot_centroids = TRUE) {
  xlim <- c(min(coords$x), max(coords$x))
  xrange <- diff(range(xlim))
  xlim <- xlim + c(-.1*xrange, .1*xrange)
  ylim <- c(min(coords$y), max(coords$y))
  yrange <- diff(range(ylim))
  ylim <- ylim + c(-.1*yrange, .1*yrange)
  
  if (isTRUE(color_points)) {
    p <- ggplot(coords, aes(x, y, color = cluster))
  } else {
    p <- ggplot(coords, aes(x, y))
  }
  
  if (isTRUE(plot_voronoi)) {
    p <- p +
      geom_voronoi_tile(
        data = voronoi_centr,
        aes(fill = cluster, group = 1L),
        alpha = 0.2,
        color = NA,
        bound = c(xlim, ylim)
      )
  }
  
  if (isTRUE(color_points)) {
    p <- p + geom_point()
  } else {
    p <- p + geom_point(color = "black")
  }
  
  if (isTRUE(plot_centroids)) {
    p <- p + 
      geom_point(
        data = centroids,
        aes(fill = cluster),
        color = "black", size = 6, shape = 21
      )
  }
  
  p +
    coord_cartesian(xlim = xlim, ylim = ylim, expand = FALSE) +
    theme_void() +
    theme(legend.position = "none")
}

```

class: middle

.center[
```{r three-clusters-kmeans1, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
set.seed(1237)
coords <- tibble(
  x = c(rnorm(100), rnorm(100, 2), rnorm(100, 4.3)),
  y = c(rnorm(100), rnorm(100, -4), rnorm(100, 1.5))
)

centroids <- random_centroids(coords, n = 3)
coords <- update_clusters(coords, centroids)

make_kmeans_plot(coords, centroids, color_points = FALSE, plot_centroids = FALSE, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans2, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, color_points = FALSE, plot_centroids = TRUE, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans3, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE, plot_voronoi = TRUE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans4, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans5, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans6, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans7, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans8, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans9, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans10, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans11, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans12, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans13, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans14, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans15, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans16, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans17, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans18, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r three-clusters-kmeans19, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---
class: middle

.center[
```{r five-clusters-kmeans1, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
# three centers, 5 clusters

set.seed(3541)
centroids <- random_centroids(coords, n = 5)
coords <- update_clusters(coords, centroids)

make_kmeans_plot(coords, centroids, color_points = FALSE, plot_centroids = FALSE, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans2, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, color_points = FALSE, plot_centroids = TRUE, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans3, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE, plot_voronoi = TRUE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans4, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans5, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans6, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans7, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans8, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans9, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans10, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans11, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans12, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans13, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans14, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans15, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans16, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans17, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids2 <- update_centroids(coords)
make_kmeans_plot(coords, centroids2, centroids, plot_voronoi = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans18, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
centroids <- centroids2
coords <- update_clusters(coords, centroids)
make_kmeans_plot(coords, centroids, centroids, color_points = FALSE)
```
]

---

class: middle

.center[
```{r five-clusters-kmeans19, echo = FALSE, fig.width = 7, fig.asp = .85, dev = "svg"}
make_kmeans_plot(coords, centroids, centroids, color_points = TRUE)
```
]

---

## Further reading

- Wikipedia: [Nonlinear dimensionality reduction](https://en.wikipedia.org/wiki/Nonlinear_dimensionality_reduction)
- Wikipedia: [t-distributed stochastic neighbor embedding](https://en.wikipedia.org/wiki/T-distributed_stochastic_neighbor_embedding)
- Wikipedia: [Kernel principal component analysis](https://en.wikipedia.org/wiki/Kernel_principal_component_analysis)
- **kernlab** reference documentation (for kernel PCA): [pdf document](https://cran.r-project.org/web/packages/kernlab/kernlab.pdf)
- **Rtsne** reference documentation: [pdf document](https://cran.r-project.org/web/packages/Rtsne/Rtsne.pdf)
- **umap** vignette: [Uniform Manifold Approximation and Projection in R](https://cran.r-project.org/web/packages/umap/vignettes/umap.html)